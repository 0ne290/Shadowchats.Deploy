name: Deploy to Minikube

on:
  workflow_dispatch:
    inputs:
      service:
        description: "–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å –¥–ª—è –¥–µ–ø–ª–æ—è"
        required: true
        type: choice
        options:
          - authentication
          - api-gateway
      version:
        description: "–í–µ—Ä—Å–∏—è (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è latest)"
        required: false

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout deploy repo
        uses: actions/checkout@v4

      - name: Install tools (yq + jq + curl)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ—Ä—Å–∏—é
        id: get_version
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          INPUT_VERSION="${{ github.event.inputs.version }}"

          if [ -n "$INPUT_VERSION" ]; then
            VERSION="$INPUT_VERSION"
          else
            echo "–í–µ—Ä—Å–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞ ‚Äî –∏—â—É –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–ª—è $SERVICE..."
            VERSION=$(curl -s "https://registry.hub.docker.com/v2/repositories/one290/shadowchats/tags?page_size=100" \
              | jq -r --arg SERVICE "$SERVICE" '.results[].name | select(startswith($SERVICE + "-v"))' \
              | sort -V | tail -n 1)
          fi

          if [ -z "$VERSION" ]; then
            echo "‚ùå –í–µ—Ä—Å–∏—è –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ $SERVICE –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            exit 1
          fi

          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: –û–±–Ω–æ–≤–∏—Ç—å deployment.yaml
        run: |
          SERVICE="${{ steps.get_version.outputs.service }}"
          VERSION="${{ steps.get_version.outputs.version }}"

          echo "‚öôÔ∏è –û–±–Ω–æ–≤–ª—è—é $SERVICE/deployment.yaml -> one290/shadowchats:${VERSION}"
          yq e -i ".spec.template.spec.containers[0].image = \"one290/shadowchats:${VERSION}\"" $SERVICE/deployment.yaml

      - name: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —Å–µ—Ä–≤–∏—Å–∞
        run: |
          SERVICE="${{ steps.get_version.outputs.service }}"
          echo "üöÄ –ü—Ä–∏–º–µ–Ω—è—é –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ $SERVICE/"
          kubectl apply -f $SERVICE/
          kubectl rollout status -f $SERVICE/deployment.yaml
