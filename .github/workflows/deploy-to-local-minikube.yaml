name: Deploy to Minikube

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Select the service to deploy"
        required: true
        type: choice
        options:
          - authentication
          - api-gateway

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout deploy repository
        uses: actions/checkout@v4

      - name: Install tools (yq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Determine service version
        id: get_version
        run: |
          set -e
          SERVICE="${{ github.event.inputs.service }}"

          # Клонируем репозиторий сервиса
          git clone --depth 1 "https://github.com/shadowchats/${SERVICE}.git" tmp_service_repo
          
          VERSION=$(cat tmp_service_repo/VERSION | tr -d ' \n')

          if [ -z "$VERSION" ]; then
            echo "❌ Version for service $SERVICE not found!"
            exit 1
          fi

          echo "service=$SERVICE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update deployment.yaml
        run: |
          SERVICE="${{ steps.get_version.outputs.service }}"
          VERSION="${{ steps.get_version.outputs.version }}"

          echo "Updating $SERVICE/deployment.yaml -> one290/shadowchats:${SERVICE}-v${VERSION}"
          yq e -i ".spec.template.spec.containers[0].image = \"one290/shadowchats:${SERVICE}-v${VERSION}\"" $SERVICE/deployment.yaml

      - name: Apply service manifests
        run: |
          SERVICE="${{ steps.get_version.outputs.service }}"
          echo "Applying manifests from $SERVICE/"
          kubectl apply -f $SERVICE/deployment.yaml
          kubectl rollout status deployment/$SERVICE
